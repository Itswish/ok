<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced HLS Player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root{--bg:#000;--card:#0f0f0f;--accent:#ff1f1f;--muted:#9aa}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#fff}
    .page{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
    h1{margin:0;font-size:20px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select, button, input[type=text]{padding:8px;border-radius:6px;border:0;background:#111;color:#fff}
    button{cursor:pointer}
    /* player container & aspect ratios */
    .player-wrap{width:100%;background:#000;border-radius:8px;overflow:hidden;margin-bottom:14px;display:flex;align-items:center;justify-content:center}
    .player-wrap video{width:100%;height:100%;display:block;object-fit:cover}
    /* aspect sizes using padding-top trick */
    .aspect-16-9{position:relative;padding-top:56.25%}
    .aspect-16-9 video{position:absolute;top:0;left:0;height:100%;width:100%}
    .aspect-4-3{position:relative;padding-top:75%}
    .aspect-4-3 video{position:absolute;top:0;left:0;height:100%;width:100%}
    .aspect-1-1{position:relative;padding-top:100%}
    .aspect-1-1 video{position:absolute;top:0;left:0;height:100%;width:100%}
    .aspect-fill{height:480px;padding-top:0}
    .aspect-fill video{position:relative;height:100%;width:100%}
    /* join grid 2x2 */
    .join-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:680px;margin:8px auto}
    .join-btn{display:inline-flex;align-items:center;justify-content:center;background:var(--accent);color:#fff;text-decoration:none;padding:12px;border-radius:8px;font-weight:700;font-size:10px}
    /* small utilities */
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    /* analysis & photo area */
    .meta{max-width:900px;margin:14px auto;padding:10px;border-radius:8px;background:#0a0a0a;border:1px solid #111}
    .hidden{display:none}
    /* cinema mode */
    body.cinema-mode{background:#000}
    body.cinema-mode .player-wrap{transform:scale(1.02);box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    /* responsive */
    @media (max-width:600px){
      .controls{flex-direction:column;align-items:flex-start}
      .join-grid{grid-template-columns:1fr 1fr;gap:10px;padding:0 8px}
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Live Stream</h1>
      <div class="controls">
        <label for="aspect">Aspect:</label>
        <select id="aspect">
          <option value="16-9" selected>16:9 (Default)</option>
          <option value="4-3">4:3</option>
          <option value="1-1">1:1 (Square)</option>
          <option value="fill">Fill (stretch)</option>
        </select>

        <button id="cinemaBtn" title="Toggle Cinema">Cinema</button>
        <button id="fsBtn" title="Fullscreen">Fullscreen</button>
        <button id="vrBtn" title="VR Mode">VR</button>
      </div>
    </header>

    <!-- player -->
    <section id="playerWrap" class="player-wrap aspect-16-9">
      <video id="video" controls playsinline></video>
    </section>

    <!-- Manual controls -->
    <div class="row" style="justify-content:center;margin-bottom:10px">
      <input id="manualUrl" type="text" placeholder="Paste m3u8 or mp4 URL here (temporary signed link)">
      <button id="loadBtn">Load</button>
      <button id="fallbackBtn">Use Server 2</button>
      <button id="analyzeBtn">Analysis</button>
    </div>

    <!-- 2x2 join buttons -->
    <section class="join-grid" id="joinGrid">
      <a class="join-btn" id="join1" href="#" target="_blank">JOIN 1</a>
      <a class="join-btn" id="join2" href="#" target="_blank">JOIN 2</a>
      <a class="join-btn" id="join3" href="#" target="_blank">JOIN 3</a>
      <a class="join-btn" id="join4" href="#" target="_blank">JOIN 4</a>
    </section>

    <!-- photo upload & preview -->
    <div class="meta" id="photoArea">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <label style="font-weight:700">Upload photo (preview local):</label>
        <input id="photoInput" type="file" accept="image/*">
        <div class="right" id="photoCount" style="color:var(--muted)"></div>
      </div>
      <div id="photoPreview" style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap"></div>
    </div>

    <!-- analysis / status -->
    <div class="meta" id="statusArea">
      <div id="statusLine">Status: Idle</div>
      <div id="analysis" class="hidden" style="margin-top:8px">
        <div>Duration: <span id="a-duration">-</span></div>
        <div>Resolution: <span id="a-res">-</span></div>
        <div>Buffered: <span id="a-buffer">-</span></div>
        <div>Manifest encryption: <span id="a-encrypted">Unknown</span></div>
      </div>
    </div>

    <footer style="text-align:center;margin-top:18px">
      <p style="font-weight:700;color:#fff">सभी लोग हमारे प्रीमियम सदस्य बनने के लिए JOIN करें</p>
    </footer>
  </div>

<script>
/* ================= CONFIG - CHANGE THESE ================= */
const DEFAULT_STREAM = "https://d14v4v80cpjht7.cloudfront.net/file_library/videos/vod_non_drm_hls/migration/6364641427112/6364641427112.m3u8";
const FALLBACK_STREAM = ""; // set your server2 fallback URL if any
const JOIN_LINKS = [
  {id:"join1", title:"JOIN NOW", url:"https://t.me/+-c580a3MZ05mNGFl"},
  {id:"join2", title:"JOIN NOW", url:"https://t.me/+-c580a3MZ05mNGFl"},
  {id:"join3", title:"JOIN NOW", url:"https://t.me/+-c580a3MZ05mNGFl"},
  {id:"join4", title:"JOIN NOW", url:"https://t.me/+-c580a3MZ05mNGFl"}
];
/* ======================================================= */

const video = document.getElementById('video');
const wrap = document.getElementById('playerWrap');
const aspect = document.getElementById('aspect');

const statusLine = document.getElementById('statusLine');
const analysisBox = document.getElementById('analysis');
const aDuration = document.getElementById('a-duration');
const aRes = document.getElementById('a-res');
const aBuffer = document.getElementById('a-buffer');
const aEncrypted = document.getElementById('a-encrypted');

const manualUrl = document.getElementById('manualUrl');
const loadBtn = document.getElementById('loadBtn');
const fallbackBtn = document.getElementById('fallbackBtn');
const analyzeBtn = document.getElementById('analyzeBtn');

const joinGrid = document.getElementById('joinGrid');

/* populate join buttons */
JOIN_LINKS.forEach(l=>{
  const el = document.getElementById(l.id);
  if(el){ el.href = l.url; el.innerText = l.title; }
});

/* HLS handling with encryption detection */
let hls = null;

async function fetchText(url){
  try{
    const resp = await fetch(url, {method:'GET', mode:'cors'});
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    const txt = await resp.text();
    return {ok:true, text:txt};
  }catch(e){
    return {ok:false, error:e};
  }
}

async function checkEncrypted(url){
  try{
    const r = await fetchText(url);
    if(!r.ok) return null;
    const txt = r.text;
    if(txt.includes('#EXT-X-KEY') || txt.includes('SAMPLE-AES') || txt.includes('EXT-X-SESSION-KEY')){
      return true;
    }
    return false;
  }catch(e){
    return null;
  }
}

function setStatus(t){
  statusLine.innerText = 'Status: ' + t;
}

/* load stream with detection and fallback */
async function loadStream(url){
  if(!url) throw new Error('Empty URL');
  setStatus('Checking URL...');
  // simple validation
  if(!/^https?:\/\//i.test(url)) throw new Error('Invalid URL (must start with http/https)');
  // detect file type
  const isM3u8 = url.toLowerCase().includes('.m3u8');
  const isMp4 = url.toLowerCase().includes('.mp4') || url.toLowerCase().includes('.m4v');

  // if HLS manifest, check for encryption
  if(isM3u8){
    setStatus('Fetching manifest...');
    const enc = await checkEncrypted(url);
    if(enc === true){
      aEncrypted.innerText = 'Yes (EXT-X-KEY found)';
      analysisBox.classList.remove('hidden');
      throw new Error('Encrypted/DRM stream detected. License required.');
    } else if(enc === null){
      aEncrypted.innerText = 'Unknown (fetch failed)';
    } else {
      aEncrypted.innerText = 'No';
    }
  } else {
    aEncrypted.innerText = 'N/A';
  }

  // proceed to play
  setStatus('Loading stream...');
  // destroy previous hls if any
  try{ if(hls){ hls.destroy(); hls = null; } } catch(e){}

  if(isM3u8 && Hls.isSupported()){
    hls = new Hls();
    return new Promise((resolve, reject)=>{
      hls.on(Hls.Events.ERROR, function(event, data){
        console.warn('HLS error', data);
        // network/fatal handling
        if(data && data.details && data.fatal){
          reject(new Error('HLS fatal error: '+data.details));
        }
      });
      hls.on(Hls.Events.MANIFEST_PARSED, function(){
        setStatus('Playing (HLS)');
        updateAnalysis();
        resolve();
      });
      hls.loadSource(url);
      hls.attachMedia(video);
    });
  } else if(isM3u8 && video.canPlayType('application/vnd.apple.mpegurl')){
    video.src = url;
    return new Promise((resolve,reject)=>{
      video.addEventListener('loadedmetadata', function once(){ video.removeEventListener('loadedmetadata',once); setStatus('Playing (native HLS)'); updateAnalysis(); resolve(); });
      video.addEventListener('error', function(){ reject(new Error('Native playback error')); });
    });
  } else if(isMp4){
    video.src = url;
    return new Promise((resolve,reject)=>{
      video.addEventListener('loadedmetadata', function once(){ video.removeEventListener('loadedmetadata',once); setStatus('Playing (MP4)'); updateAnalysis(); resolve(); });
      video.addEventListener('error', function(){ reject(new Error('MP4 playback error')); });
    });
  } else {
    throw new Error('Unknown stream type');
  }
}

/* try multiple URLs */
async function tryPlay(urls){
  setStatus('Attempting to play...');
  for(const u of urls){
    if(!u) continue;
    try{
      await loadStream(u);
      setStatus('Playing: ' + u);
      return true;
    }catch(err){
      console.warn('Failed:', u, err);
      setStatus('Failed: ' + (err.message||err));
      continue;
    }
  }
  setStatus('All streams failed');
  return false;
}

/* update analysis info */
function updateAnalysis(){
  analysisBox.classList.remove('hidden');
  aDuration.innerText = isFinite(video.duration) ? formatTime(video.duration) : 'Live/Unknown';
  aRes.innerText = (video.videoWidth || '-') + ' x ' + (video.videoHeight || '-');
  const buffered = video.buffered && video.buffered.length ? video.buffered.end(video.buffered.length-1) : 0;
  aBuffer.innerText = buffered ? formatTime(buffered) : '-';
}

/* helpers */
function formatTime(s){
  if(!isFinite(s)) return '-';
  const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = Math.floor(s%60);
  if(h>0) return `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
  return `${m}:${String(sec).padStart(2,'0')}`;
}

/* initial load */
window.addEventListener('load', ()=>{
  // set UI defaults
  if(DEFAULT_STREAM) manualUrl.value = DEFAULT_STREAM;
  // try play default and fallback
  const urls = [DEFAULT_STREAM, FALLBACK_STREAM].filter(Boolean);
  if(urls.length) tryPlay(urls);

  // orientation behavior (auto show/hide controls if needed)
  handleOrientation();
});

/* UI events */
loadBtn.addEventListener('click', async ()=>{
  const u = manualUrl.value.trim();
  if(!u){ alert('Paste a valid URL'); return; }
  try{
    await tryPlay([u, FALLBACK_STREAM].filter(Boolean));
  }catch(e){ console.error(e); alert('Play failed: '+e.message); }
});

fallbackBtn.addEventListener('click', async ()=>{
  if(!FALLBACK_STREAM){ alert('Fallback stream not configured'); return; }
  tryPlay([FALLBACK_STREAM]);
});

document.getElementById('cinemaBtn').addEventListener('click', ()=>{ document.body.classList.toggle('cinema-mode'); });
document.getElementById('fsBtn').addEventListener('click', ()=>{
  if(!document.fullscreenElement) wrap.requestFullscreen().catch(()=>{}); else document.exitFullscreen().catch(()=>{});
});
document.getElementById('analyzeBtn').addEventListener('click', ()=>{ updateAnalysis(); alert('Analysis updated (see below).'); });

/* aspect select */
aspect.addEventListener('change', ()=>{
  const v = aspect.value;
  wrap.className = 'player-wrap ' + ({'16-9':'aspect-16-9','4-3':'aspect-4-3','1-1':'aspect-1-1','fill':'aspect-fill'}[v] || 'aspect-16-9');
});

/* VR button - simple try with WebXR */
document.getElementById('vrBtn').addEventListener('click', async ()=>{
  if(navigator.xr && navigator.xr.isSessionSupported){
    try{
      const supported = await navigator.xr.isSessionSupported('immersive-vr');
      if(!supported){ alert('VR not supported on this device/browser'); return; }
      // WebXR session requires more setup (and an appropriate canvas). We'll provide a polite message for now.
      alert('VR supported. For full VR playback integrate with WebXR rendering pipeline (outside scope).');
    }catch(e){ alert('VR check failed'); }
  } else {
    alert('WebXR not available on this browser.');
  }
});

/* orientation auto behavior: portrait -> keep controls / chat; landscape -> hide chat/compact
   (we only change analysis area visibility here; chat was earlier integrated separately) */
function handleOrientation(){
  if(window.innerHeight > window.innerWidth){
    // portrait
    document.getElementById('statusArea').style.display = 'block';
  } else {
    // landscape
    document.getElementById('statusArea').style.display = 'none';
  }
}
window.addEventListener('resize', handleOrientation);

/* photo upload preview */
const photoInput = document.getElementById('photoInput');
const photoPreview = document.getElementById('photoPreview');
const photoCount = document.getElementById('photoCount');
photoInput.addEventListener('change', ()=>{
  const files = Array.from(photoInput.files || []);
  photoPreview.innerHTML = '';
  files.forEach(f=>{
    const url = URL.createObjectURL(f);
    const img = document.createElement('img');
    img.src = url; img.style.width = '140px'; img.style.height = 'auto'; img.style.borderRadius='8px';
    photoPreview.appendChild(img);
  });
  photoCount.innerText = files.length ? files.length + ' photo(s) previewed' : '';
});

/* optional: clickable join links load their .m3u8 into player */
joinGrid.addEventListener('click', (e)=>{
  const a = e.target.closest('a.join-btn');
  if(!a) return;
  const href = a.href || '';
  if(href.includes('.m3u8') || href.includes('.mp4')) {
    manualUrl.value = href;
    tryPlay([href, FALLBACK_STREAM].filter(Boolean));
  }
});

</script>
</body>
          </html>
